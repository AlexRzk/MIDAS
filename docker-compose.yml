version: '3.8'

services:
  # ============================================
  # Rust WebSocket Collector
  # Collects L2 depth and trade streams from Binance
  # ============================================
  collector:
    build:
      context: ./collector
      dockerfile: Dockerfile
    container_name: midas-collector
    restart: unless-stopped
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - SYMBOL=${SYMBOL:-btcusdt}
      - RAW_DATA_PATH=/data/raw
      - FILE_ROTATION_HOURS=${FILE_ROTATION_HOURS:-1}
      - FILE_ROTATION_GB=${FILE_ROTATION_GB:-1}
      - RECONNECT_DELAY_SECS=${RECONNECT_DELAY_SECS:-5}
      - MAX_RECONNECT_ATTEMPTS=${MAX_RECONNECT_ATTEMPTS:-0}
    volumes:
      - raw_data:/data/raw
      - ./logs/collector:/app/logs
    networks:
      - midas-network
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    healthcheck:
      test: ["CMD-SHELL", "test -f /data/raw/*.jsonl.zst || exit 0"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # Python Processor
  # Reconstructs order book from raw updates
  # ============================================
  processor:
    build:
      context: ./processor
      dockerfile: Dockerfile
    container_name: midas-processor
    restart: unless-stopped
    depends_on:
      - collector
    environment:
      - PYTHONUNBUFFERED=1
      - SYMBOL=${SYMBOL:-btcusdt}
      - RAW_DATA_PATH=/data/raw
      - CLEAN_DATA_PATH=/data/clean
      - SNAPSHOT_INTERVAL_MS=${SNAPSHOT_INTERVAL_MS:-100}
      - ORDER_BOOK_DEPTH=${ORDER_BOOK_DEPTH:-10}
      - PROCESS_BATCH_SIZE=${PROCESS_BATCH_SIZE:-100000}
    volumes:
      - raw_data:/data/raw:ro
      - clean_data:/data/clean
      - ./logs/processor:/app/logs
    networks:
      - midas-network
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"

  # ============================================
  # Python Feature Generator
  # Computes OFI, imbalance, and other ML features
  # ============================================
  features:
    build:
      context: ./features
      dockerfile: Dockerfile
    container_name: midas-features
    restart: unless-stopped
    depends_on:
      - processor
    environment:
      - PYTHONUNBUFFERED=1
      - SYMBOL=${SYMBOL:-btcusdt}
      - CLEAN_DATA_PATH=/data/clean
      - FEATURES_DATA_PATH=/data/features
      - TIME_BUCKET_MS=${TIME_BUCKET_MS:-100}
      - OFI_WINDOW=${OFI_WINDOW:-10}
      - ORDER_BOOK_DEPTH=${ORDER_BOOK_DEPTH:-10}
      - PARQUET_ROW_GROUP_SIZE=${PARQUET_ROW_GROUP_SIZE:-50000}
    volumes:
      - clean_data:/data/clean:ro
      - features_data:/data/features
      - ./logs/features:/app/logs
    networks:
      - midas-network
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"

# ============================================
# Named Volumes for Data Persistence
# ============================================
volumes:
  raw_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/raw
  
  clean_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/clean
  
  features_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/features

# ============================================
# Network Configuration
# ============================================
networks:
  midas-network:
    driver: bridge
