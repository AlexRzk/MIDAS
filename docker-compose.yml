services:
  # ============================================
  # Rust WebSocket Collector
  # Collects L2 depth and trade streams from Binance
  # ============================================
  collector:
    build:
      context: ./collector
      dockerfile: Dockerfile
    container_name: midas-collector
    restart: unless-stopped
    environment:
      - RUST_LOG=${RUST_LOG:-debug}
      - SYMBOL=${SYMBOL:-btcusdt}
      - RAW_DATA_PATH=/data/raw
      - FILE_ROTATION_HOURS=${FILE_ROTATION_HOURS:-1}
      - FILE_ROTATION_GB=${FILE_ROTATION_GB:-1}
      - RECONNECT_DELAY_SECS=${RECONNECT_DELAY_SECS:-5}
      - MAX_RECONNECT_ATTEMPTS=${MAX_RECONNECT_ATTEMPTS:-0}
      - ENABLE_LIQUIDATIONS=${ENABLE_LIQUIDATIONS:-false}
      - ENABLE_KLINES=${ENABLE_KLINES:-false}
    volumes:
      - raw_data:/data/raw
      - ./logs/collector:/app/logs
    networks:
      - midas-network
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    healthcheck:
      test: ["CMD-SHELL", "find /data/raw -name '*.jsonl.zst' -mmin -120 | grep -q . || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  # ============================================
  # Python Processor
  # Reconstructs order book from raw updates
  # ============================================
  processor:
    build:
      context: ./processor
      dockerfile: Dockerfile
    container_name: midas-processor
    restart: unless-stopped
    depends_on:
      collector:
        condition: service_healthy
    environment:
      - PYTHONUNBUFFERED=1
      - SYMBOL=${SYMBOL:-btcusdt}
      - RAW_DATA_PATH=/data/raw
      - CLEAN_DATA_PATH=/data/clean
      - SNAPSHOT_INTERVAL_MS=${SNAPSHOT_INTERVAL_MS:-100}
      - ORDER_BOOK_DEPTH=${ORDER_BOOK_DEPTH:-10}
      - PROCESS_BATCH_SIZE=${PROCESS_BATCH_SIZE:-100000}
      - ENABLE_GAP_RECOVERY=${ENABLE_GAP_RECOVERY:-true}
      - CHECKPOINT_INTERVAL=${CHECKPOINT_INTERVAL:-10000}
    volumes:
      - raw_data:/data/raw:ro
      - clean_data:/data/clean
      - ./logs/processor:/app/logs
    networks:
      - midas-network
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # ============================================
  # Python Feature Generator
  # Computes OFI, imbalance, and other ML features
  # ============================================
  features:
    build:
      context: ./features
      dockerfile: Dockerfile
    container_name: midas-features
    restart: unless-stopped
    depends_on:
      processor:
        condition: service_healthy
    environment:
      - PYTHONUNBUFFERED=1
      - SYMBOL=${SYMBOL:-btcusdt}
      - CLEAN_DATA_PATH=/data/clean
      - FEATURES_DATA_PATH=/data/features
      - TIME_BUCKET_MS=${TIME_BUCKET_MS:-100}
      - OFI_WINDOW=${OFI_WINDOW:-10}
      - ORDER_BOOK_DEPTH=${ORDER_BOOK_DEPTH:-10}
      - PARQUET_ROW_GROUP_SIZE=${PARQUET_ROW_GROUP_SIZE:-50000}
      - ENABLE_ADVANCED_FEATURES=${ENABLE_ADVANCED_FEATURES:-true}
    volumes:
      - clean_data:/data/clean:ro
      - features_data:/data/features
      - ./logs/features:/app/logs
    networks:
      - midas-network
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # ============================================
  # Prometheus Metrics (optional)
  # ============================================
  prometheus:
    image: prom/prometheus:v2.45.0
    container_name: midas-prometheus
    restart: unless-stopped
    profiles:
      - monitoring
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=7d'
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - midas-network

  # ============================================
  # Grafana Dashboard (optional)
  # ============================================
  grafana:
    image: grafana/grafana:10.0.0
    container_name: midas-grafana
    restart: unless-stopped
    profiles:
      - monitoring
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    ports:
      - "3000:3000"
    networks:
      - midas-network
    depends_on:
      - prometheus

  # ============================================
  # Tools container
  # Used for running one-off scripts, validation, and debugging
  # This mounts the repo into /app and allows running scripts that are not baked into other images
  # Example: docker compose run --rm tools python scripts/validate_features.py --dir /app/data/features
  tools:
    image: python:3.11-slim
    container_name: midas-tools
    volumes:
      - ./:/app
    working_dir: /app
    environment:
      - PYTHONUNBUFFERED=1
    entrypoint: ["/bin/bash", "-c"]
    command: ["sleep infinity"]
    networks:
      - midas-network

# ============================================
# Named Volumes for Data Persistence
# ============================================
volumes:
  raw_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/raw
  
  clean_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/clean
  
  features_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/features

  prometheus_data:
    driver: local

  grafana_data:
    driver: local

# ============================================
# Network Configuration
# ============================================
networks:
  midas-network:
    driver: bridge
